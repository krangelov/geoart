<html>
	<head>
		<script>
			function Point(x,y) {
				this.x = x;
				this.y = y;
			}
			Point.prototype.radius = 6;
			Point.prototype.draw = function(ctx) {
				ctx.beginPath();
				ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
				ctx.closePath();
				ctx.fill();
			}
			Point.prototype.isHit = function (x,y) {
				return (Math.sqrt((this.x-x)**2+(this.y-y)**2) <= this.radius);
			}

			function Line(a,b) {
				this.a = a;
				this.b = b;
			}
			Line.prototype.draw = function(ctx) {
				ctx.beginPath();				
				var y = (this.a.y*this.b.x - this.b.y*this.a.x)/(this.b.x-this.a.x);
				ctx.moveTo(0, y);
				var y = (this.a.y*(this.b.x-ctx.canvas.width) + this.b.y*(ctx.canvas.width-this.a.x))/(this.b.x-this.a.x);
				ctx.lineTo(ctx.canvas.width, y);
				ctx.closePath();
				ctx.stroke();
			}
			Line.prototype.intersect = function(that) {
				return that.intersectLine(this);
			}
			Line.prototype.intersectLine = function(that) {
				return new Point
				 (((this.a.x*this.b.y - this.a.y*this.b.x)*(that.a.x-that.b.x) - (this.a.x-this.b.x)*(that.a.x*that.b.y - that.a.y*that.b.x))/((this.a.x-this.b.x)*(that.a.y-that.b.y) - (this.a.y-this.b.y)*(that.a.x-that.b.x))
				 ,((this.a.x*this.b.y - this.a.y*this.b.x)*(that.a.y-that.b.y) - (this.a.y-this.b.y)*(that.a.x*that.b.y - that.a.y*that.b.x))/((this.a.x-this.b.x)*(that.a.y-that.b.y) - (this.a.y-this.b.y)*(that.a.x-that.b.x))
				 );
			}
			Line.prototype.intersectCircle = function(that) {
				var a  = (this.b.x - this.a.x)**2 + (this.b.y - this.a.y)**2;
				var b  = (this.a.x - that.c.x)*(this.a.x-this.b.x) + (this.a.y-that.c.y)*(this.a.y-this.b.y);
				var c  = (this.a.x - that.c.x)**2 + (this.a.y - that.c.y)**2;
				var r2 = (that.c.x - that.d.x)**2 + (that.c.y - that.d.y)**2;
				var l1 = (b + Math.sqrt(b**2 - a*(c-r2)))/a;
				var l2 = (b - Math.sqrt(b**2 - a*(c-r2)))/a;
				return [new Point(this.a.x*(1-l1)+this.b.x*l1,this.a.y*(1-l1)+this.b.y*l1)
				       ,new Point(this.a.x*(1-l2)+this.b.x*l2,this.a.y*(1-l2)+this.b.y*l2)
				       ]
			}

			function Circle(c,d) {
				this.c = c;
				this.d = d;
			}
			Circle.prototype.draw = function(ctx) {
				ctx.beginPath();
				var r = Math.sqrt((this.c.x-this.d.x)**2 + (this.c.y-this.d.y)**2);
				ctx.arc(this.c.x, this.c.y, r, 0, 2 * Math.PI);
				ctx.closePath();
				ctx.stroke();
			}
			Circle.prototype.intersect = function(that) {
				return that.intersectCircle(this);
			}
			Circle.prototype.intersectLine = function(that) {
				var a  = (that.b.x - that.a.x)**2 + (that.b.y - that.a.y)**2;
				var b  = (that.a.x - this.c.x)*(that.a.x-that.b.x) + (that.a.y-this.c.y)*(that.a.y-that.b.y);
				var c  = (that.a.x - this.c.x)**2 + (that.a.y - this.c.y)**2;
				var r2 = (this.c.x - this.d.x)**2 + (this.c.y - this.d.y)**2;
				var l1 = (b + Math.sqrt(b**2 - a*(c-r2)))/a;
				var l2 = (b - Math.sqrt(b**2 - a*(c-r2)))/a;
				return [new Point(that.a.x*(1-l1)+that.b.x*l1,that.a.y*(1-l1)+that.b.y*l1)
				       ,new Point(that.a.x*(1-l2)+that.b.x*l2,that.a.y*(1-l2)+that.b.y*l2)
				       ]
			}
			Circle.prototype.intersectCircle = function(that) {
				var r2 = (this.c.x-this.d.x)**2 + (this.c.y-this.d.y)**2;
				var R2 = (that.c.x-that.d.x)**2 + (that.c.y-that.d.y)**2;
				var d  = Math.sqrt((this.c.x-that.c.x)**2 + (this.c.y-that.c.y)**2);
				var a  = (r2 - R2 + d*d)/(2*d);
				var h  = Math.sqrt(r2 - a*a);
				var x  = this.c.x + (that.c.x-this.c.x)*(a/d);
				var y  = this.c.y + (that.c.y-this.c.y)*(a/d);

				return [new Point(x + h*(that.c.y - this.c.y)/d, y - h*(that.c.x - this.c.x)/d)
					   ,new Point(x - h*(that.c.y - this.c.y)/d, y + h*(that.c.x - this.c.x)/d)]
			}

			function Arc(c,d,p) {
				Circle.call(this,c,d);
				this.p = p;
			}
			Arc.prototype = Object.create(Circle.prototype);
			Arc.prototype.draw = function(ctx) {
				ctx.beginPath();
				var r = Math.sqrt((this.c.x-this.d.x)**2 + (this.c.y-this.d.y)**2);
				var a1 = Math.asin((this.p.y-this.c.y)/r);
				if (this.c.x > this.p.x) a1 = Math.PI-a1;
				var a2 = 2*Math.PI-Math.asin((this.c.y-this.d.y)/r);
				if (this.c.x > this.d.x) a2 = Math.PI-a2;
				ctx.arc(this.c.x, this.c.y, r, a1, a2);
				ctx.stroke();
			}

			function onLoad() {
				var a = new Point(400,400);
				var b = new Point(150,250);

				var canvas = document.getElementById("myCanvas");
				var code   = document.getElementById("myCode");
				canvas.state = {};
				canvas.state.points = [a,b]
				canvas.state.focus  = null;

				onCodeChange(code, canvas);
			}
			
			function onDraw() {
				var canvas = document.getElementById("myCanvas");
				var ctx = canvas.getContext("2d");
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				canvas.code(ctx,canvas.state.points);
			}

			function onMouseDown(canvas,event) {
				for (var i in canvas.state.points) {
					var point = canvas.state.points[i];
					if (point.isHit(event.offsetX,event.offsetY)) {
						canvas.state.focus = point;
						break;
					}
				}
			}
			
			function onMouseMove(canvas,event) {
				if (canvas.state.focus != null) {
					canvas.state.focus.x = event.offsetX;
					canvas.state.focus.y = event.offsetY;
					onDraw();
				}
			}
			
			function onMouseUp(canvas,event) {
				canvas.state.focus = null;
			}
			
			function onCodeChange(code, canvas) {
				try {
					eval("canvas.code = function(ctx,points) {"+code.value+"}");
					onDraw();
				} catch (e) {
					//alert(e.message);
				}
			}
		</script>
	</head>
	<body onload="onLoad()">
		<table>
			<tr>
				<td>
					<textarea id="myCode" style="height: 900px; width: 400px" oninput="onCodeChange(this,document.getElementById('myCanvas'))">
[p1,p2] = points;

var c0 = new Circle(p1,p2);
var c1 = new Circle(p2,p1);

[p3,p4] = c1.intersect(c0);
var c2 = new Circle(p3,p1);

[p4,p5] = c2.intersect(c0);
var c3 = new Circle(p4,p1);

[p6,p7] = c3.intersect(c0);
var c4 = new Circle(p6,p1);

[p8,p9] = c4.intersect(c0);
var c5 = new Circle(p8,p1);

[p10,p11] = c5.intersect(c0);
var c6 = new Circle(p10,p1);

var l1  = new Line(p1,p2);
var l2  = new Line(p1,p3);
var l3  = new Line(p1,p4);
var l4  = new Line(p1,p5);
var l5  = new Line(p1,p6);
var l6  = new Line(p1,p8);
var l7  = new Line(p1,p10);
var l8  = new Line(p2,p4);
var l9  = new Line(p4,p8);
var l10 = new Line(p8,p2);
var p11 = l8.intersect(l2);
var p12 = l9.intersect(l4);
var p13 = l10.intersect(l3);
var c7  = new Circle(p2,p11);
var c8  = new Circle(p4,p12);
var c9  = new Circle(p8,p13);
var [p14,p15] = l1.intersect(c7);
var [p16,p17] = l3.intersect(c8);
var [p18,p19] = l6.intersect(c9);
var c10 = new Circle(p1,p14);
var a1  = new Arc(p2,p14,p13);
var a2  = new Arc(p4,p16,p11);
var a3  = new Arc(p8,p18,p12);

p1.draw(ctx);
p2.draw(ctx);
/*c0.draw(ctx);
c1.draw(ctx);
c2.draw(ctx);
c3.draw(ctx);
c4.draw(ctx);
c5.draw(ctx);
c6.draw(ctx);
l1.draw(ctx);
l2.draw(ctx);
l3.draw(ctx);
l4.draw(ctx);
l5.draw(ctx);
l6.draw(ctx);
l7.draw(ctx);
l8.draw(ctx);
l9.draw(ctx);
l10.draw(ctx);
p11.draw(ctx);
p12.draw(ctx);
p13.draw(ctx);
p14.draw(ctx);
c7.draw(ctx);
c8.draw(ctx);
c9.draw(ctx);
p17.draw(ctx);*/
a1.draw(ctx);
a2.draw(ctx);
a3.draw(ctx);
c10.draw(ctx);
					</textarea>
				</td>
				<td>
					<canvas id="myCanvas" width="1500" height="900", onmousedown="onMouseDown(this,event)" onmousemove="onMouseMove(this,event)" onMouseUp="onMouseUp(this,event)">
					</canvas>
				</td>
			</tr>
		</table>
	</body>
</html>

